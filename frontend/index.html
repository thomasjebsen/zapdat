<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>zapdat - Instant Table Insights</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Shadcn-inspired light theme */
            --primary: #18181b;
            --primary-dark: #09090b;
            --primary-light: #3f3f46;
            --secondary: #71717a;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #ea580c;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --border-secondary: #cbd5e1;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-lg: rgba(0, 0, 0, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 4rem;
            animation: fadeInDown 0.8s ease;
        }

        .logo {
            font-size: 4rem;
            font-weight: 700;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            letter-spacing: -0.02em;
        }

        .tagline {
            font-size: 1.5rem;
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 1rem;
            line-height: 1.4;
        }

        .description {
            font-size: 1.125rem;
            color: var(--text-secondary);
            max-width: 700px;
            margin: 0 auto 2rem;
            line-height: 1.7;
        }

        .hero-badges {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .badge-icon {
            font-size: 1.125rem;
        }

        /* Upload Section */
        .upload-section {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 3rem;
            margin-bottom: 3rem;
            box-shadow: 0 4px 6px -1px var(--shadow), 0 2px 4px -2px var(--shadow);
            animation: fadeInUp 0.8s ease 0.2s both;
            position: relative;
        }

        .upload-area {
            border: 2px dashed var(--border-secondary);
            border-radius: 16px;
            padding: 4rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 50%, #f8fafc 100%);
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            opacity: 0;
            transition: all 0.4s ease;
        }

        .upload-area::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(99, 102, 241, 0.1) 50%,
                transparent 70%
            );
            opacity: 0;
            transform: rotate(0deg);
            transition: all 0.6s ease;
        }

        .upload-area:hover {
            border-color: #6366f1;
            background: linear-gradient(135deg, #f8fafc 0%, #faf5ff 50%, #f8fafc 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px -4px rgba(99, 102, 241, 0.2);
        }

        .upload-area:hover::before {
            opacity: 0.03;
        }

        .upload-area:hover::after {
            opacity: 1;
            animation: shimmer 2s infinite;
        }

        .upload-area:hover .upload-icon {
            transform: translateY(-10px) scale(1.1);
        }

        .upload-area.dragover {
            border-color: #6366f1;
            border-style: solid;
            background: linear-gradient(135deg, #eef2ff 0%, #f5f3ff 100%);
            transform: scale(1.02);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1), 0 12px 24px -8px rgba(99, 102, 241, 0.3);
        }

        .upload-area.dragover::before {
            opacity: 0.05;
        }

        .upload-area.dragover .upload-icon {
            animation: bounce 0.6s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { transform: rotate(0deg) translateX(-100%); }
            100% { transform: rotate(0deg) translateX(100%); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0) scale(1.1); }
            50% { transform: translateY(-20px) scale(1.15); }
        }

        input[type="file"] {
            display: none;
        }

        .upload-content {
            position: relative;
            z-index: 1;
        }

        .upload-icon {
            font-size: 5rem;
            margin-bottom: 1.5rem;
            animation: float 3s ease-in-out infinite;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 4px 8px rgba(99, 102, 241, 0.2));
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .upload-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .upload-hint {
            color: var(--text-muted);
            font-size: 1rem;
            font-weight: 400;
        }

        .upload-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
            padding: 0.875rem 2rem;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            position: relative;
            overflow: hidden;
        }

        .upload-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .upload-button:hover::before {
            left: 100%;
        }

        .upload-button:active {
            transform: translateY(0);
        }

        /* File Preview Card */
        .file-preview {
            display: none;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            animation: fadeInUp 0.4s ease;
        }

        .file-preview.active {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .file-preview-icon {
            font-size: 2.5rem;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        .file-preview-info {
            flex: 1;
        }

        .file-preview-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            font-size: 1.05rem;
        }

        .file-preview-size {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .file-preview-remove {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.2);
            color: #dc2626;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .file-preview-remove:hover {
            background: rgba(220, 38, 38, 0.15);
            border-color: rgba(220, 38, 38, 0.3);
        }

        /* Loading State */
        .loading {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .loading.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .spinner-container {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto 2rem;
        }

        .spinner {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 5px solid transparent;
            border-top-color: #6366f1;
            border-right-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }

        .spinner:nth-child(2) {
            border-top-color: #8b5cf6;
            border-right-color: #a78bfa;
            animation-delay: -0.4s;
            width: 80%;
            height: 80%;
            top: 10%;
            left: 10%;
        }

        .spinner:nth-child(3) {
            border-top-color: #a78bfa;
            border-right-color: #c4b5fd;
            animation-delay: -0.8s;
            width: 60%;
            height: 60%;
            top: 20%;
            left: 20%;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.125rem;
            font-weight: 600;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: pulse 2s ease-in-out infinite;
        }

        .loading-subtext {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        /* Error State */
        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 1rem 1.25rem;
            border-radius: 6px;
            margin-top: 1.5rem;
            display: none;
            animation: shake 0.5s ease;
            font-size: 0.875rem;
        }

        .error.active {
            display: block;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Features Section */
        .features-section {
            margin-bottom: 4rem;
        }

        .section-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .section-title {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .section-subtitle {
            font-size: 1.125rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
        }

        .feature-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            transition: all 0.3s ease;
            animation: fadeInUp 0.6s ease;
        }

        .feature-card:nth-child(2) {
            animation-delay: 0.1s;
        }

        .feature-card:nth-child(3) {
            animation-delay: 0.2s;
        }

        .feature-card:nth-child(4) {
            animation-delay: 0.3s;
        }

        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px -4px var(--shadow);
            border-color: var(--border-secondary);
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .feature-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .feature-description {
            color: var(--text-secondary);
            line-height: 1.6;
            font-size: 0.95rem;
        }

        /* Examples Section */
        .examples-section {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 3rem;
            margin-bottom: 4rem;
        }

        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .example-item {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.2s ease;
        }

        .example-item:hover {
            border-color: #6366f1;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
        }

        .example-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6366f1;
            margin-bottom: 0.5rem;
        }

        .example-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .example-description {
            font-size: 0.875rem;
            color: var(--text-muted);
            line-height: 1.5;
        }

        /* Results */
        .results {
            display: none;
            animation: fadeInUp 0.6s ease;
        }

        .results.active {
            display: block;
        }

        /* Overview Card */
        .overview-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px 0 var(--shadow), 0 1px 2px -1px var(--shadow);
        }

        .card-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 2rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .overview-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .stat-box {
            background: var(--primary);
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px 0 var(--shadow), 0 1px 2px -1px var(--shadow);
        }

        .stat-box:hover {
            box-shadow: 0 4px 6px -1px var(--shadow), 0 2px 4px -2px var(--shadow);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: white;
        }

        .stat-label {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Column Cards */
        .column-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px 0 var(--shadow), 0 1px 2px -1px var(--shadow);
            transition: all 0.2s ease;
        }

        .column-card:hover {
            border-color: var(--border-secondary);
            box-shadow: 0 4px 6px -1px var(--shadow), 0 2px 4px -2px var(--shadow);
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .column-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .column-type {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 0.375rem 0.875rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border: 1px solid var(--border);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-item {
            background: var(--bg-secondary);
            padding: 1.25rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .stat-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-secondary);
        }

        .stat-item-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .stat-item-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .plot-container {
            margin-top: 2rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            min-height: 400px;
        }

        /* Collapsible sections */
        .collapsible-section {
            margin-top: 1.5rem;
        }

        .collapsible-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .collapsible-header:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-secondary);
        }

        .collapsible-header h4 {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }

        .collapsible-icon {
            font-size: 0.875rem;
            color: var(--text-muted);
            transition: transform 0.2s ease;
        }

        .collapsible-icon.expanded {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.expanded {
            max-height: 500px;
            overflow-y: auto;
        }

        .collapsible-content-inner {
            padding: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 8px 8px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.95);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .logo {
                font-size: 2.5rem;
            }

            .tagline {
                font-size: 1rem;
            }

            .upload-section {
                padding: 1.5rem;
            }

            .upload-area {
                padding: 2rem 1rem;
            }

            .column-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-secondary);
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        /* Custom Chart Builder */
        .chart-builder {
            display: none;
            animation: fadeInUp 0.6s ease;
        }

        .chart-builder.active {
            display: block;
        }

        .builder-card {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px var(--shadow);
        }

        .chart-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .chart-type-btn {
            background: rgba(15, 23, 42, 0.5);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .chart-type-btn:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
            transform: translateY(-2px);
        }

        .chart-type-btn.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
        }

        .chart-type-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .chart-type-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .chart-type-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-select, .form-input {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.875rem 1rem;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .form-select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .generate-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 2.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(99, 102, 241, 0.5);
        }

        .generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .custom-chart-container {
            margin-top: 2rem;
        }

        .chart-item {
            background: rgba(15, 23, 42, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
            animation: fadeInUp 0.4s ease;
        }

        .chart-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .chart-item-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-item-delete {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .chart-item-delete:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .color-schemes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.75rem;
        }

        .color-scheme-btn {
            padding: 0.75rem;
            background: rgba(15, 23, 42, 0.5);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .color-scheme-btn:hover {
            border-color: var(--primary);
        }

        .color-scheme-btn.active {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">zapdat</div>
            <h1 class="tagline">Instant insights from your CSV data</h1>
            <p class="description">
                Upload your CSV file and get powerful analytics in seconds. No setup, no coding, no data ever leaves your browser.
                Just drag, drop, and discover what your data is telling you.
            </p>
            <div class="hero-badges">
                <span class="badge">
                    <span class="badge-icon">üîí</span>
                    <span>100% Client-Side</span>
                </span>
                <span class="badge">
                    <span class="badge-icon">‚ö°</span>
                    <span>Instant Analysis</span>
                </span>
                <span class="badge">
                    <span class="badge-icon">üìä</span>
                    <span>Smart Visualizations</span>
                </span>
            </div>
        </header>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-content">
                    <div class="upload-icon">üìä</div>
                    <div class="upload-text">Drop your data file here</div>
                    <div class="upload-hint">or click to browse ‚Ä¢ Supports CSV, Excel, JSON, Parquet, and more</div>
                    <button class="upload-button">
                        <span>‚ú®</span>
                        <span>Choose File</span>
                    </button>
                </div>
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.json,.tsv,.txt,.parquet,.feather,.pkl,.pickle,.db,.sqlite,.sqlite3,.h5,.hdf5,.orc">
            </div>

            <div class="file-preview" id="filePreview">
                <div class="file-preview-icon">üìÑ</div>
                <div class="file-preview-info">
                    <div class="file-preview-name" id="fileName">sample.csv</div>
                    <div class="file-preview-size" id="fileSize">0 KB</div>
                </div>
                <button class="file-preview-remove" id="removeFile">‚úï Remove</button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner-container">
                    <div class="spinner"></div>
                    <div class="spinner"></div>
                    <div class="spinner"></div>
                </div>
                <p class="loading-text">Analyzing your data...</p>
                <p class="loading-subtext">This won't take long</p>
            </div>

            <div class="error" id="error"></div>
        </div>

        <!-- Features Section -->
        <section class="features-section">
            <div class="section-header">
                <h2 class="section-title">What You'll Get</h2>
                <p class="section-subtitle">Powerful analytics made simple. No data science degree required.</p>
            </div>
            <div class="features-grid">
                <div class="feature-card">
                    <span class="feature-icon">üéØ</span>
                    <h3 class="feature-title">Automatic Type Detection</h3>
                    <p class="feature-description">
                        Smart identification of numeric, categorical, text, and datetime columns.
                        We handle the complexity so you don't have to.
                    </p>
                </div>
                <div class="feature-card">
                    <span class="feature-icon">üìà</span>
                    <h3 class="feature-title">Essential Statistics</h3>
                    <p class="feature-description">
                        Mean, median, standard deviation, quartiles, and more. Get the stats that actually matter,
                        presented clearly and beautifully.
                    </p>
                </div>
                <div class="feature-card">
                    <span class="feature-icon">üé®</span>
                    <h3 class="feature-title">Interactive Visualizations</h3>
                    <p class="feature-description">
                        Histograms, bar charts, scatter plots, and correlation matrices.
                        All rendered instantly with professional-grade Plotly charts.
                    </p>
                </div>
                <div class="feature-card">
                    <span class="feature-icon">üîç</span>
                    <h3 class="feature-title">Data Quality Insights</h3>
                    <p class="feature-description">
                        Spot missing values, duplicates, and outliers at a glance.
                        Know exactly what you're working with before diving deeper.
                    </p>
                </div>
            </div>
        </section>

        <!-- Examples Section -->
        <section class="examples-section">
            <div class="section-header">
                <h2 class="section-title">Perfect For</h2>
                <p class="section-subtitle">From quick data checks to deep analysis, zapdat has you covered</p>
            </div>
            <div class="examples-grid">
                <div class="example-item">
                    <div class="example-label">Sales Data</div>
                    <div class="example-title">Revenue Analysis</div>
                    <p class="example-description">
                        Upload your sales CSV and instantly see trends, top products, and revenue distributions by category or region.
                    </p>
                </div>
                <div class="example-item">
                    <div class="example-label">Marketing</div>
                    <div class="example-title">Campaign Performance</div>
                    <p class="example-description">
                        Track conversion rates, identify best-performing channels, and spot anomalies in your marketing data.
                    </p>
                </div>
                <div class="example-item">
                    <div class="example-label">Customer Data</div>
                    <div class="example-title">User Behavior</div>
                    <p class="example-description">
                        Analyze user demographics, engagement patterns, and retention metrics without writing a single line of code.
                    </p>
                </div>
                <div class="example-item">
                    <div class="example-label">Financial</div>
                    <div class="example-title">Expense Tracking</div>
                    <p class="example-description">
                        Get instant breakdowns of spending by category, identify outliers, and visualize budget allocation.
                    </p>
                </div>
                <div class="example-item">
                    <div class="example-label">Scientific</div>
                    <div class="example-title">Research Data</div>
                    <p class="example-description">
                        Quick exploratory analysis of experimental results, correlation studies, and distribution analysis.
                    </p>
                </div>
                <div class="example-item">
                    <div class="example-label">Operations</div>
                    <div class="example-title">Performance Metrics</div>
                    <p class="example-description">
                        Monitor KPIs, track system performance, and identify bottlenecks in your operational data.
                    </p>
                </div>
            </div>
        </section>

        <div class="chart-builder" id="chartBuilder">
            <div class="builder-card">
                <h2 class="card-title">
                    <span>üé®</span>
                    Custom Chart Builder
                </h2>

                <div class="chart-types" id="chartTypes">
                    <div class="chart-type-btn" data-type="scatter">
                        <div class="chart-type-icon">üìä</div>
                        <div class="chart-type-name">Scatter Plot</div>
                        <div class="chart-type-desc">X vs Y correlation</div>
                    </div>
                    <div class="chart-type-btn" data-type="line">
                        <div class="chart-type-icon">üìà</div>
                        <div class="chart-type-name">Line Chart</div>
                        <div class="chart-type-desc">Trends over time</div>
                    </div>
                    <div class="chart-type-btn" data-type="box">
                        <div class="chart-type-icon">üì¶</div>
                        <div class="chart-type-name">Box Plot</div>
                        <div class="chart-type-desc">Compare distributions</div>
                    </div>
                    <div class="chart-type-btn" data-type="violin">
                        <div class="chart-type-icon">üéª</div>
                        <div class="chart-type-name">Violin Plot</div>
                        <div class="chart-type-desc">Distribution density</div>
                    </div>
                    <div class="chart-type-btn" data-type="correlation">
                        <div class="chart-type-icon">üî•</div>
                        <div class="chart-type-name">Heatmap</div>
                        <div class="chart-type-desc">Correlation matrix</div>
                    </div>
                    <div class="chart-type-btn" data-type="pie">
                        <div class="chart-type-icon">ü•ß</div>
                        <div class="chart-type-name">Pie Chart</div>
                        <div class="chart-type-desc">Proportional breakdown</div>
                    </div>
                    <div class="chart-type-btn" data-type="bar">
                        <div class="chart-type-icon">üìä</div>
                        <div class="chart-type-name">Bar Chart</div>
                        <div class="chart-type-desc">Compare categories</div>
                    </div>
                </div>

                <div id="chartOptions"></div>

                <button class="generate-btn" id="generateChart" disabled>
                    <span>‚ú®</span>
                    <span>Generate Chart</span>
                </button>

                <div class="custom-chart-container" id="customChartContainer"></div>
            </div>
        </div>

        <div class="results" id="results">
            <div class="overview-card">
                <h2 class="card-title">
                    <span>üìã</span>
                    Dataset Overview
                </h2>
                <div class="overview-stats" id="overviewStats"></div>
            </div>
            <div id="columnAnalysis"></div>
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const errorDiv = document.getElementById('error');
        const uploadButton = document.querySelector('.upload-button');
        const filePreview = document.getElementById('filePreview');
        const removeFileBtn = document.getElementById('removeFile');

        // Chart builder state
        let currentCacheKey = null;
        let columnInfo = null;
        let selectedChartType = null;
        let currentFile = null;

        // Click handlers
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadButton.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.click();
        });

        // Remove file handler
        removeFileBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            clearFile();
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                currentFile = file;
                showFilePreview(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                currentFile = file;
                showFilePreview(file);
            }
        });

        function showFilePreview(file) {
            // Show file details
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            filePreview.classList.add('active');

            // Auto-analyze after a short delay for better UX
            setTimeout(() => {
                if (currentFile) handleFile(currentFile);
            }, 800);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function clearFile() {
            currentFile = null;
            fileInput.value = '';
            filePreview.classList.remove('active');
            results.classList.remove('active');
            document.getElementById('chartBuilder').classList.remove('active');
            errorDiv.classList.remove('active');
        }

        async function handleFile(file) {
            // Validate file extension
            const supportedFormats = ['.csv', '.xlsx', '.xls', '.json', '.tsv', '.txt',
                                     '.parquet', '.feather', '.pkl', '.pickle',
                                     '.db', '.sqlite', '.sqlite3', '.h5', '.hdf5', '.orc'];
            const fileExt = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();

            if (!supportedFormats.includes(fileExt)) {
                showError(`Unsupported file format. Supported: ${supportedFormats.join(', ')}`);
                clearFile();
                return;
            }

            errorDiv.classList.remove('active');
            results.classList.remove('active');
            loading.classList.add('active');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('http://localhost:8000/analyze', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    let errorMessage = 'Analysis failed';
                    try {
                        const error = await response.json();
                        errorMessage = error.detail || errorMessage;
                    } catch (e) {
                        // If response is not JSON, use status text
                        errorMessage = `Server error: ${response.status} ${response.statusText}`;
                    }
                    console.error('Analysis error:', errorMessage);
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                displayResults(data.analysis);

                // Store cache key and load chart builder
                if (data.cache_key) {
                    currentCacheKey = data.cache_key;
                    await loadChartBuilder();
                }

                // Keep file preview visible after successful analysis
            } catch (error) {
                console.error('Error in handleFile:', error);
                showError(error.message);
                clearFile();
            } finally {
                loading.classList.remove('active');
            }
        }

        function showError(message) {
            errorDiv.textContent = '‚ö†Ô∏è ' + message;
            errorDiv.classList.add('active');
        }

        function displayResults(analysis) {
            results.classList.add('active');
            results.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            // Display overview
            const overview = analysis.overview;
            const overviewStats = document.getElementById('overviewStats');

            const totalMissing = Object.values(overview.missing_values).reduce((a, b) => a + b, 0);

            overviewStats.innerHTML = `
                <div class="stat-box" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
                    <div class="stat-value">${overview.rows.toLocaleString()}</div>
                    <div class="stat-label">Rows</div>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                    <div class="stat-value">${overview.columns}</div>
                    <div class="stat-label">Columns</div>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <div class="stat-value">${totalMissing.toLocaleString()}</div>
                    <div class="stat-label">Missing Values</div>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <div class="stat-value">${overview.duplicates.toLocaleString()}</div>
                    <div class="stat-label">Duplicates</div>
                </div>
            `;

            // Display column analysis
            const columnAnalysis = document.getElementById('columnAnalysis');
            columnAnalysis.innerHTML = '';

            for (const [columnName, columnData] of Object.entries(analysis.columns)) {
                const card = createColumnCard(columnName, columnData);
                columnAnalysis.appendChild(card);
            }
        }

        function createColumnCard(name, data) {
            const card = document.createElement('div');
            card.className = 'column-card';

            const typeEmoji = {
                'numeric': 'üî¢',
                'categorical': 'üè∑Ô∏è',
                'text': 'üìù',
                'datetime': 'üìÖ'
            };

            const header = `
                <div class="column-header">
                    <div class="column-name">${typeEmoji[data.type] || 'üìä'} ${name}</div>
                    <div class="column-type">${data.type}</div>
                </div>
            `;

            let statsHtml = '';
            if (data.analysis && data.analysis.stats) {
                const stats = data.analysis.stats;

                // Format stat labels to be more readable
                const formatLabel = (key) => {
                    return key.replace(/_/g, ' ')
                        .replace(/\b\w/g, l => l.toUpperCase())
                        .replace(/Pct/g, '%')
                        .replace(/Std/g, 'Std Dev')
                        .replace(/Q25/g, '25th Percentile')
                        .replace(/Q75/g, '75th Percentile');
                };

                const formatValue = (value) => {
                    if (value === null || value === undefined) {
                        return 'N/A';
                    } else if (typeof value === 'number') {
                        return Number.isInteger(value) ?
                            value.toLocaleString() :
                            value.toFixed(2);
                    } else {
                        return value;
                    }
                };

                // Define basic stats by type
                const basicNumericStats = ['count', 'mean', 'median', 'min', 'max', 'missing'];
                const advancedNumericStats = ['std', 'q25', 'q75', 'outliers', 'outlier_pct', 'skewness', 'distribution_shape', 'zeros', 'negatives', 'typical_min', 'typical_max'];
                const basicCategoricalStats = ['count', 'unique', 'mode', 'mode_pct', 'missing', 'diversity'];
                const basicTextStats = ['count', 'unique', 'missing', 'pattern_hint'];
                const advancedTextStats = ['avg_length', 'min_length', 'max_length'];

                // Determine which stats to show in main grid
                let mainStats = {};
                let advancedStats = {};

                if (data.type === 'numeric') {
                    for (const [key, value] of Object.entries(stats)) {
                        if (basicNumericStats.includes(key)) {
                            mainStats[key] = value;
                        } else if (advancedNumericStats.includes(key)) {
                            advancedStats[key] = value;
                        }
                    }
                } else if (data.type === 'categorical') {
                    for (const [key, value] of Object.entries(stats)) {
                        if (basicCategoricalStats.includes(key)) {
                            mainStats[key] = value;
                        }
                    }
                } else if (data.type === 'text') {
                    for (const [key, value] of Object.entries(stats)) {
                        if (basicTextStats.includes(key)) {
                            mainStats[key] = value;
                        } else if (advancedTextStats.includes(key)) {
                            advancedStats[key] = value;
                        }
                    }
                } else {
                    mainStats = stats;
                }

                // Display main stats
                statsHtml = '<div class="stats-grid">';
                for (const [key, value] of Object.entries(mainStats)) {
                    statsHtml += `
                        <div class="stat-item">
                            <div class="stat-item-label">${formatLabel(key)}</div>
                            <div class="stat-item-value">${formatValue(value)}</div>
                        </div>
                    `;
                }
                statsHtml += '</div>';

                // Add advanced stats in collapsible section if present
                if (Object.keys(advancedStats).length > 0) {
                    const sectionId = `advanced-${name.replace(/[^a-zA-Z0-9]/g, '-')}-${Date.now()}`;
                    statsHtml += `
                        <div class="collapsible-section">
                            <div class="collapsible-header" onclick="toggleCollapsible('${sectionId}')">
                                <h4>üìä Advanced Statistics</h4>
                                <span class="collapsible-icon" id="${sectionId}-icon">‚ñº</span>
                            </div>
                            <div class="collapsible-content" id="${sectionId}">
                                <div class="collapsible-content-inner">
                                    <div class="stats-grid">
                    `;
                    for (const [key, value] of Object.entries(advancedStats)) {
                        statsHtml += `
                            <div class="stat-item">
                                <div class="stat-item-label">${formatLabel(key)}</div>
                                <div class="stat-item-value">${formatValue(value)}</div>
                            </div>
                        `;
                    }
                    statsHtml += `
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // Add value counts table for categorical data (collapsible)
            let valueCountsHtml = '';
            if (data.analysis && data.analysis.value_counts) {
                const counts = data.analysis.value_counts;
                const remaining = data.analysis.remaining_categories || 0;
                const totalCount = data.analysis.stats ? data.analysis.stats.count : 0;
                const sectionId = `values-${name.replace(/[^a-zA-Z0-9]/g, '-')}-${Date.now()}`;

                valueCountsHtml = `
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="toggleCollapsible('${sectionId}')">
                            <h4>üìã Category Breakdown (${Object.keys(counts).length} shown${remaining > 0 ? `, +${remaining} more` : ''})</h4>
                            <span class="collapsible-icon" id="${sectionId}-icon">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="${sectionId}">
                            <div class="collapsible-content-inner">
                                <table style="width: 100%; font-size: 0.85rem;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid var(--border);">
                                            <th style="padding: 0.5rem; text-align: left; color: var(--text-muted); font-weight: 600;">Category</th>
                                            <th style="padding: 0.5rem; text-align: right; color: var(--text-muted); font-weight: 600;">Count</th>
                                            <th style="padding: 0.5rem; text-align: right; color: var(--text-muted); font-weight: 600;">%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;

                for (const [category, count] of Object.entries(counts)) {
                    const percentage = totalCount > 0 ? ((count / totalCount) * 100).toFixed(1) : '0';
                    valueCountsHtml += `
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 0.5rem; color: var(--text-primary);">${category}</td>
                            <td style="padding: 0.5rem; text-align: right; font-weight: 500; color: var(--text-primary);">${count.toLocaleString()}</td>
                            <td style="padding: 0.5rem; text-align: right; color: var(--text-secondary);">${percentage}%</td>
                        </tr>
                    `;
                }

                valueCountsHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Add samples for text data (collapsible)
            let samplesHtml = '';
            if (data.analysis && data.analysis.samples && data.analysis.samples.length > 0) {
                const sectionId = `samples-${name.replace(/[^a-zA-Z0-9]/g, '-')}-${Date.now()}`;
                samplesHtml = `
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="toggleCollapsible('${sectionId}')">
                            <h4>üìù Sample Values (${data.analysis.samples.length})</h4>
                            <span class="collapsible-icon" id="${sectionId}-icon">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="${sectionId}">
                            <div class="collapsible-content-inner">
                `;

                data.analysis.samples.forEach((sample, idx) => {
                    samplesHtml += `<div style="padding: 0.5rem; ${idx < data.analysis.samples.length - 1 ? 'border-bottom: 1px solid var(--border);' : ''} color: var(--text-primary); font-family: monospace; font-size: 0.85rem;">${sample}</div>`;
                });

                samplesHtml += `
                            </div>
                        </div>
                    </div>
                `;
            }

            card.innerHTML = header + statsHtml + valueCountsHtml + samplesHtml;

            // Add plot if available
            if (data.analysis && data.analysis.plot) {
                const plotDiv = document.createElement('div');
                plotDiv.className = 'plot-container';
                const sanitizedName = name.replace(/[^a-zA-Z0-9]/g, '-');
                plotDiv.id = `plot-${sanitizedName}-${Date.now()}`;
                card.appendChild(plotDiv);

                // Render plot with dark theme after DOM is ready
                try {
                    const plotData = JSON.parse(data.analysis.plot);

                    // Ensure we have valid data
                    if (!plotData || !plotData.data || !plotData.layout) {
                        console.warn(`Invalid plot data for ${name}`);
                        return card;
                    }

                    const layout = {
                        ...plotData.layout,
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        font: {
                            color: '#0f172a',
                            family: 'Inter, sans-serif'
                        },
                        xaxis: {
                            ...(plotData.layout.xaxis || {}),
                            gridcolor: '#e2e8f0',
                            color: '#0f172a',
                            zerolinecolor: '#cbd5e1'
                        },
                        yaxis: {
                            ...(plotData.layout.yaxis || {}),
                            gridcolor: '#e2e8f0',
                            color: '#0f172a',
                            zerolinecolor: '#cbd5e1'
                        }
                    };

                    // Use setTimeout to ensure DOM is ready
                    setTimeout(() => {
                        Plotly.newPlot(plotDiv, plotData.data, layout, {
                            responsive: true,
                            displayModeBar: true,
                            modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                            displaylogo: false
                        }).catch(err => {
                            console.error(`Failed to render plot for ${name}:`, err);
                            plotDiv.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">Chart unavailable</p>';
                        });
                    }, 100);
                } catch (err) {
                    console.error(`Error processing plot for ${name}:`, err);
                    plotDiv.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">Chart unavailable</p>';
                }
            }

            return card;
        }

        // Toggle collapsible sections
        function toggleCollapsible(sectionId) {
            const content = document.getElementById(sectionId);
            const icon = document.getElementById(`${sectionId}-icon`);

            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                icon.classList.add('expanded');
            }
        }

        // ============ CUSTOM CHART BUILDER ============

        async function loadChartBuilder() {
            try {
                // Fetch column info
                const response = await fetch(`http://localhost:8000/column_info/${currentCacheKey}`);
                if (!response.ok) {
                    throw new Error('Failed to load column info');
                }
                columnInfo = await response.json();

                // Show chart builder
                document.getElementById('chartBuilder').classList.add('active');
                setupChartTypeListeners();
            } catch (error) {
                console.error('Error loading chart builder:', error);
            }
        }

        function setupChartTypeListeners() {
            const chartTypeBtns = document.querySelectorAll('.chart-type-btn');
            chartTypeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active class from all buttons
                    chartTypeBtns.forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    btn.classList.add('active');

                    // Update selected chart type
                    selectedChartType = btn.dataset.type;

                    // Generate form fields (this will reset the form)
                    generateChartOptions(selectedChartType);

                    // Enable generate button
                    document.getElementById('generateChart').disabled = false;
                });
            });

            // Generate chart button - remove old listener and add new one
            const generateBtn = document.getElementById('generateChart');
            const newGenerateBtn = generateBtn.cloneNode(true);
            generateBtn.parentNode.replaceChild(newGenerateBtn, generateBtn);
            newGenerateBtn.addEventListener('click', generateCustomChart);
        }

        function generateChartOptions(chartType) {
            const optionsDiv = document.getElementById('chartOptions');
            let html = '<div class="form-grid">';

            switch (chartType) {
                case 'scatter':
                    html += createSelect('x_column', 'X-Axis Column', columnInfo.numeric_columns);
                    html += createSelect('y_column', 'Y-Axis Column', columnInfo.numeric_columns);
                    html += createSelect('color_column', 'Color By (Optional)', ['None', ...columnInfo.all_columns]);
                    html += createSelect('size_column', 'Size By (Optional)', ['None', ...columnInfo.numeric_columns]);
                    break;

                case 'line':
                    html += createSelect('x_column', 'X-Axis Column', columnInfo.all_columns);
                    html += createMultiSelect('y_columns', 'Y-Axis Columns', columnInfo.numeric_columns);
                    break;

                case 'box':
                case 'violin':
                    html += createMultiSelect('columns', 'Columns to Compare', columnInfo.numeric_columns);
                    html += createSelect('group_by', 'Group By (Optional)', ['None', ...columnInfo.categorical_columns]);
                    break;

                case 'correlation':
                    html += `
                        <div class="form-group">
                            <label class="form-label">Columns</label>
                            <p style="color: var(--text-muted); font-size: 0.9rem;">All numeric columns will be used</p>
                        </div>
                    `;
                    break;

                case 'pie':
                    html += createSelect('x_column', 'Category Column', columnInfo.categorical_columns);
                    html += `
                        <div class="form-group">
                            <label class="form-label">Top N Values</label>
                            <input type="number" id="top_n" class="form-input" value="10" min="3" max="20">
                        </div>
                    `;
                    break;

                case 'bar':
                    html += createSelect('x_column', 'X-Axis Column', columnInfo.all_columns);
                    html += createSelect('y_column', 'Y-Axis Column', columnInfo.numeric_columns);
                    break;
            }

            // Common options
            html += `
                <div class="form-group">
                    <label class="form-label">Chart Title (Optional)</label>
                    <input type="text" id="chart_title" class="form-input" placeholder="Auto-generated">
                </div>
            `;

            html += '</div>';

            // Color schemes
            html += `
                <div class="form-group" style="margin-top: 1.5rem;">
                    <label class="form-label">Color Scheme</label>
                    <div class="color-schemes">
                        ${['viridis', 'plasma', 'inferno', 'blues', 'purples', 'ocean', 'sunset', 'rainbow', 'pastel', 'bold']
                            .map((scheme, i) => `
                                <div class="color-scheme-btn ${i === 0 ? 'active' : ''}" data-scheme="${scheme}">
                                    ${scheme}
                                </div>
                            `).join('')}
                    </div>
                </div>
            `;

            optionsDiv.innerHTML = html;

            // Add color scheme listeners
            document.querySelectorAll('.color-scheme-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.color-scheme-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });
        }

        function createSelect(id, label, options) {
            return `
                <div class="form-group">
                    <label class="form-label">${label}</label>
                    <select id="${id}" class="form-select">
                        ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                    </select>
                </div>
            `;
        }

        function createMultiSelect(id, label, options) {
            return `
                <div class="form-group">
                    <label class="form-label">${label}</label>
                    <select id="${id}" class="form-select" multiple size="5">
                        ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                    </select>
                    <small style="color: var(--text-muted); font-size: 0.8rem;">Hold Ctrl/Cmd to select multiple</small>
                </div>
            `;
        }

        async function generateCustomChart() {
            const generateBtn = document.getElementById('generateChart');
            const chartContainer = document.getElementById('customChartContainer');

            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span>‚è≥</span><span>Generating...</span>';

            try {
                // Build request payload
                const payload = {
                    cache_key: currentCacheKey,
                    chart_type: selectedChartType,
                    color_scheme: document.querySelector('.color-scheme-btn.active')?.dataset.scheme || 'viridis',
                    title: document.getElementById('chart_title')?.value || null
                };

                // Add chart-specific fields
                switch (selectedChartType) {
                    case 'scatter':
                        payload.x_column = document.getElementById('x_column').value;
                        payload.y_column = document.getElementById('y_column').value;
                        const colorCol = document.getElementById('color_column').value;
                        if (colorCol !== 'None') payload.color_column = colorCol;
                        const sizeCol = document.getElementById('size_column')?.value;
                        if (sizeCol && sizeCol !== 'None') payload.size_column = sizeCol;
                        break;

                    case 'line':
                        payload.x_column = document.getElementById('x_column').value;
                        payload.y_columns = Array.from(document.getElementById('y_columns').selectedOptions).map(opt => opt.value);
                        break;

                    case 'box':
                    case 'violin':
                        payload.columns = Array.from(document.getElementById('columns').selectedOptions).map(opt => opt.value);
                        const groupBy = document.getElementById('group_by')?.value;
                        if (groupBy && groupBy !== 'None') payload.group_by = groupBy;
                        break;

                    case 'pie':
                        payload.x_column = document.getElementById('x_column').value;
                        payload.top_n = parseInt(document.getElementById('top_n')?.value || 10);
                        break;

                    case 'bar':
                        payload.x_column = document.getElementById('x_column').value;
                        payload.y_column = document.getElementById('y_column').value;
                        break;
                }

                // Send request
                const response = await fetch('http://localhost:8000/custom_chart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Chart generation failed');
                }

                const data = await response.json();

                // Create new chart item
                const chartId = `chart-${Date.now()}`;
                const chartItem = document.createElement('div');
                chartItem.className = 'chart-item';
                chartItem.id = `item-${chartId}`;

                // Get chart title from payload or use default
                const chartTitle = payload.title || getDefaultChartTitle(selectedChartType, payload);

                chartItem.innerHTML = `
                    <div class="chart-item-header">
                        <div class="chart-item-title">${getChartTypeEmoji(selectedChartType)} ${chartTitle}</div>
                        <button class="chart-item-delete" onclick="deleteChart('item-${chartId}')">üóëÔ∏è Delete</button>
                    </div>
                    <div id="${chartId}"></div>
                `;

                // Prepend chart (newest first)
                chartContainer.insertBefore(chartItem, chartContainer.firstChild);

                // Render plot
                const plotData = JSON.parse(data.chart);
                const layout = {
                    ...plotData.layout,
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: {
                        color: '#f1f5f9',
                        family: 'Inter, sans-serif'
                    },
                    xaxis: {
                        ...(plotData.layout.xaxis || {}),
                        gridcolor: '#334155',
                        color: '#f1f5f9'
                    },
                    yaxis: {
                        ...(plotData.layout.yaxis || {}),
                        gridcolor: '#334155',
                        color: '#f1f5f9'
                    }
                };

                setTimeout(() => {
                    Plotly.newPlot(chartId, plotData.data, layout, {
                        responsive: true,
                        displayModeBar: true,
                        displaylogo: false
                    });
                }, 100);

                // Scroll to new chart
                chartItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            } catch (error) {
                showError(error.message);
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<span>‚ú®</span><span>Generate Chart</span>';
            }
        }

        function getChartTypeEmoji(chartType) {
            const emojis = {
                'scatter': 'üìä',
                'line': 'üìà',
                'box': 'üì¶',
                'violin': 'üéª',
                'correlation': 'üî•',
                'pie': 'ü•ß',
                'bar': 'üìä'
            };
            return emojis[chartType] || 'üìä';
        }

        function getDefaultChartTitle(chartType, payload) {
            switch (chartType) {
                case 'scatter':
                    return `${payload.y_column} vs ${payload.x_column}`;
                case 'line':
                    return `${payload.y_columns.join(', ')} over ${payload.x_column}`;
                case 'box':
                case 'violin':
                    return `Distribution of ${payload.columns.join(', ')}`;
                case 'correlation':
                    return 'Correlation Heatmap';
                case 'pie':
                    return `${payload.x_column} Distribution`;
                case 'bar':
                    return `${payload.y_column} by ${payload.x_column}`;
                default:
                    return 'Custom Chart';
            }
        }

        function deleteChart(chartItemId) {
            const chartItem = document.getElementById(chartItemId);
            if (chartItem) {
                chartItem.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => chartItem.remove(), 300);
            }
        }
    </script>
</body>
</html>
